{% load static %}

<div>
    <h2 class="basket__title">Корзина</h2>
<form class="basket__form">  
    <input type="checkbox" id="select_all" name="select_all" class="custom_checkbox">
    <label for="select_all" class="select_all_label">Выбрать всё</label>
    <ul class="basket__item_list">
        {% for basket_user in baskets %}
            <li class="basket__item">
                <input type="checkbox" id="{{ basket_user.id }}" name="basket_item" >
                <div class="item_box">

                    {% if basket_user.product.image %}
                        <div class="img_decor_card">
                            <img src="{{ basket_user.product.image.url }}" alt="" class="item__img">
                        </div>
                    {% else %}
                        <img src="{% static 'deps/отсутсвует.png' %}" alt="" class="item__img">
                    {% endif %}

                    <div class="pos_box_price">
                        <h3 class="item__name">{{ basket_user.product.name|truncatechars:21 }}</h3>
                        <p class="item__price">{{ basket_user.products_price|floatformat:"0" }}  ₽</p>
                        <p class="item__sort_descr">{{ basket_user.product.description|truncatechars:35 }}</p>
                        <p class="item__platform">{{ basket_user.product.category }}</p>
                        <div class="item__counter_box">
                            <span class="input_group_btn">

                                <button type="button" class="counter_btn decrement"
                                    data-basket-id="{{ basket_user.id }}"
                                    data-basket-change-url="{% url "basket:basket_change" %}">
                                    {% csrf_token %}
                                    -</button>

                            </span>
                            
                            <input type="text" class="form-control number" value="{{ basket_user.quantity }}"
                                readonly>

                            <span class="input_group_btn">

                                <button type="button" class="counter_btn increment"
                                    data-basket-id="{{ basket_user.id }}"
                                    data-basket-change-url="{% url "basket:basket_change" %}">
                                    {% csrf_token %}
                                    +</button>

                            </span>
                        </div>
                        <a href="{% url "basket:basket_remove" %}" class="delete_product_btn remove-from-basket"
                            data-basket-id="{{ basket_user.id }}">
                        {% csrf_token %}
                            <svg width="19.000000" height="21.000000" viewBox="0 0 19 21" fill="none" opacity="0.6"
                                xmlns="http://www.w3.org/2000/svg"
                                xmlns:xlink="http://www.w3.org/1999/xlink">
                                <desc>
                                    Created with Pixso.
                                </desc>
                                <defs />
                                <path id="Vector"
                                    d="M14.15 20.22L4.04 20.22C2.92 20.22 3.38 20.22 2.02 20.22L2.02 5.05L0 5.05L0 3.03L4.04 3.03L4.04 2.02C4.04 0.9 4.04 0.38 4.04 0L14.15 0C14.19 1 14.15 0.9 14.15 2.02L14.15 3.03L18.19 3.03L18.19 5.05L16.17 5.05L16.17 20.22C14.83 20.22 15.27 20.22 14.15 20.22ZM4.04 5.05L4.04 18.2L14.15 18.2L14.15 5.05L4.04 5.05ZM6.06 2.02L6.06 3.03L12.13 3.03L12.13 2.02L6.06 2.02ZM12.13 16.17L10.11 16.17L10.11 7.07L12.13 7.07L12.13 16.17ZM8.08 16.17L6.06 16.17L6.06 7.07L8.08 7.07L8.08 16.17Z"
                                    fill="#1C2541" fill-opacity="1.000000" fill-rule="nonzero" />
                            </svg>
                        </a>
                    </div>
                </div>
            </li> 
        {% endfor %}

    </ul>
</form>
</div>
<div class="right_basket_container">
    <div class="paymen_method_form">
        <div class="paymen_method_form__container">
            <h3 class="paymen_method_form__title">Способ оплаты</h3>
            <form id="paymentMethodForm" method="post">
                {% csrf_token %}
                <ul class="btn_choose_payment_list">
                    {% for payment_method in payment_methods %}
                        <li class="choice_payment_method" data-payment-id="{{ payment_method.id }}">
                            {% csrf_token %}
                            {% if not user.payment_method %}
                                {% if forloop.first %}
                                    <input type="radio" id="{{ payment_method.id }}" value="{{ payment_method.id }}" name="payment_way" class="payment_way_radio visually_hidden" checked>
                                {% else %}
                                    <input type="radio" id="{{ payment_method.id }}" value="{{ payment_method.id }}" name="payment_way" class="payment_way_radio visually_hidden">
                                {% endif %}
                            {% else %}
                                <input type="radio" id="{{ payment_method.id }}" value="{{ payment_method.id }}" name="payment_way" class="payment_way_radio visually_hidden" {% if user.payment_method.id == payment_method.id %}checked{% endif %}>
                            {% endif %}
                            <label for="{{ payment_method.id }}" class="payment_way_label">{{ payment_method.bank }} ⋅⋅ {{ payment_method.card_num|slice:"-4:" }}</label>
                        </li>
                    {% endfor %}
                </ul>
                <a class="show_more_btn">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.2857 10.2857V18H7.71429V10.2857H0V7.71429H7.71429V0H10.2857V7.71429H18V10.2857H10.2857Z" fill="#1C2541"/>
                    </svg>
                    Показать ещё
                </a>
            </form>
            <a href="{% url "user:profile" %}"><button id="add_payment_button" class="payment_way payment_way__btn_chose btn ">Добавить способ оплаты</button></a>
        </div>
    </div>
    
    {% if baskets %}
        <p id="products-in-basket-count" class="products_counter">Товары, {{ baskets.total_quantity }} шт.</p>
        <div class="total_price_container">
            <p class="total_price_name"><b>Итого</b></p>
            <p class="total_price_num"><b>{{ baskets.total_price }} &#8381;</b></p>
        </div>
        <a href="{% url "orders:create_order" %}"><button class="payment_way__btn btn">КУПИТЬ</button></a>
    {% else %}
        <button class="payment_way__btn btn">КУПИТЬ</button>
    {% endif %}
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const buttonShowMore = document.querySelector('.show_more_btn');
        const PaymentList = document.querySelector('.btn_choose_payment_list');
        const payMethod = Array.from(PaymentList.querySelectorAll('.choice_payment_method'));
        
        payMethod.slice(2).forEach(review => {
            review.style.display = 'none';
        });
    
        if (payMethod.length <= 2) {
            buttonShowMore.style.display = 'none';
        }
    
        buttonShowMore.addEventListener('click', function() {
            payMethod.slice(2).forEach(review => {
                review.style.display = 'block';
            });
            buttonShowMore.style.display = 'none';
        });
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var paymentWayRadios = document.querySelectorAll('input[type=radio][name=payment_way]');
        paymentWayRadios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    var selectedPaymentMethodId = this.value;
                    var csrfToken = '{{ csrf_token }}';
                    var url = '/save_payment_method/';

                    fetch('{% url "users:save_payment_method_id" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: 'payment_method=' + encodeURIComponent(selectedPaymentMethodId)
                    })
                }
            });
        });

        $(document).on("change", 'input[type=radio][name=payment_way]', function() {
            if (this.checked) {
                var selectedPaymentMethodId = this.value;
                var csrfToken = '{{ csrf_token }}';
                var url = '/save_payment_method/';

                fetch('{% url "users:save_payment_method_id" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: 'payment_method=' + encodeURIComponent(selectedPaymentMethodId)
                })
            }
        });
    });
</script>
