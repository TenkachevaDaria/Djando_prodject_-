{% extends "pattern.html" %}
{% load static %}
{% load goods_tags %}

{% block css %}
    <link rel="stylesheet" href="{% static "ccs/products_menu.css" %}">
    <link rel="stylesheet" href="{% static "adaptation/products_media.css" %}">
{% endblock %}

{% block burger %}
    <details class="burger_menu">
        <summary class="filters_menu">
            <svg width="14.000000" height="13.000000" viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                <desc>
                        Created with Pixso.
                </desc>
                <defs/>
                <path id="Line 5" d="M0.01 2.35L0 2.37C-0.43 2.37 -0.75 2.04 -0.75 1.62C-0.75 1.2 -0.43 0.87 0 0.87L0.01 0.89L0.01 2.35ZM12.98 0.89L13 0.87C13.42 0.87 13.75 1.2 13.75 1.62C13.75 2.04 13.42 2.37 13 2.37L12.98 2.35L12.98 0.89Z" fill="#D9D9D9" fill-opacity="1.000000" fill-rule="nonzero"/>
                <path id="Line 5" d="M0 1.62L13 1.62" stroke="#1C2541" stroke-opacity="1.000000" stroke-width="1.500000" stroke-linecap="round"/>
                <path id="Line 6" d="M0.01 12.64L0 12.66C-0.43 12.66 -0.75 12.33 -0.75 11.91C-0.75 11.49 -0.43 11.16 0 11.16L0.01 11.18L0.01 12.64ZM12.98 11.18L13 11.16C13.42 11.16 13.75 11.49 13.75 11.91C13.75 12.33 13.42 12.66 13 12.66L12.98 12.64L12.98 11.18Z" fill="#D9D9D9" fill-opacity="1.000000" fill-rule="nonzero"/>
                <path id="Line 6" d="M0 11.91L13 11.91" stroke="#1C2541" stroke-opacity="1.000000" stroke-width="1.500000" stroke-linecap="round"/>
                <path id="Line 7" d="M0.01 7.23L0 7.25C-0.43 7.25 -0.75 6.91 -0.75 6.5C-0.75 6.08 -0.43 5.75 0 5.75L0.01 5.76L0.01 7.23ZM12.98 5.76L13 5.75C13.42 5.75 13.75 6.08 13.75 6.5C13.75 6.91 13.42 7.25 13 7.25L12.98 7.23L12.98 5.76Z" fill="#D9D9D9" fill-opacity="1.000000" fill-rule="nonzero"/>
                <path id="Line 7" d="M0 6.5L13 6.5" stroke="#1C2541" stroke-opacity="1.000000" stroke-width="1.500000" stroke-linecap="round"/>
                <ellipse id="Ellipse 8" cx="3.500000" cy="1.625000" rx="1.500000" ry="1.625000" fill="#1C2541" fill-opacity="1.000000"/>
                <ellipse id="Ellipse 8" cx="3.500000" cy="1.625000" rx="1.000000" ry="1.125000" stroke="#1C2541" stroke-opacity="1.000000" stroke-width="1.000000"/>
                <ellipse id="Ellipse 9" cx="10.500000" cy="5.958984" rx="1.500000" ry="1.625000" fill="#1C2541" fill-opacity="1.000000"/>
                <ellipse id="Ellipse 9" cx="10.500000" cy="5.958984" rx="1.000000" ry="1.125000" stroke="#1C2541" stroke-opacity="1.000000" stroke-width="1.000000"/>
                <ellipse id="Ellipse 10" cx="2.500000" cy="11.375000" rx="1.500000" ry="1.625000" fill="#1C2541" fill-opacity="1.000000"/>
            </svg>
        </summary>
        <div class="burger_filters">
            <div class="close_icon">
                <div class="burger_stick_close3"></div>
                <div class="burger_stick_close4"></div>
            </div>
            <h3 class="filters_producs__title">Фильтры</h3>
            <form id="price_form" action="{% url 'catalog:index' %}" method='get'>
                <div class="price_spread_box">
                    <p class="price_spread_box__name">Цена, &#8381;</p>
                    <div class="price-range">
                        <div class="price_rage__input_label">
                            <label for="price_from">От</label>
                            <input type="text" name='sort_price_from' id="price_from" placeholder="{{ min_price }}" class="filter_price">
                        </div>
                        <div class="price_rage__input_label">
                            <label for="price_to">До</label>
                            <input type="text" name='sort_price_to' id="price_to" placeholder="{{ max_price }}" class="filter_price">
                        </div>
                    </div>
                </div>
            </form>

            <form id="subscription_filter" action="{% if request.GET.q %}{% url 'catalog:search' %}{% else %}{% url 'catalog:index' %}{% endif %}" method="get">
                <div class="validity_box">
                    <h4 class="validity_title">Срок действия</h4>
                    <ul class="validity_list">

                        {% for subscription in subscriptions %}
                            <li class="validity_list__item">
                                <button id="{{ subscription.slug }}" name="subscription" value="{{ subscription.id }}" class="filter_btn">

                                    {% if request.GET.subscription == subscription.id|stringformat:"s" %}
                                        <input type="checkbox" class="custom_checkbox" checked>
                                    {% else %}
                                        <input type="checkbox" class="custom_checkbox">
                                    {% endif %}

                                    <label for="{{ subscription.slug }}" class="filter_label">{{ subscription.name }}</label>
                                </button>
                            </li>
                        {% endfor %}

                    </ul>
                </div>
            </form>


            <form id="in_stock_filter" action="{% url "catalog:index" %}" method='get'>
                <div class="in_stock_box">
                    <input type="submit" id="stock_checkbox" name="in_stock" value="true" class="custom_checkbox">
                    <label for="stock_checkbox" class="stock_label">В наличии</label>
                </div>
            </form>

            <form id="category_filter" action="{% url "catalog:index" %}" method='get'>
                <div class="operating_system_box">
                    <h4 class="operating_system_title">Операционная система</h4>
                    <ul class="operating_system_list">

                        {% for category in categories %}
                            {% if category.name != 'Все' %}
                                <li class="operating_system">
                                    <button id="{{ category.slug }}" name="category" value="{{ category.id }}" class="filter_btn">

                                        {% if request.GET.category == category.id|stringformat:"s" %}
                                            <input type="checkbox" class="custom_checkbox" checked>
                                        {% else %}
                                            <input type="checkbox" class="custom_checkbox">
                                        {% endif %}

                                        <label for="{{ category.slug }}">{{ category.name }}</label>
                                    </button>
                                </li>
                            {% endif %}
                        {% endfor %}

                    </ul>
                </div>
            </form>
        </div>
    </details>
    <details class="burger_menu">
        <summary class="sort_menu">
            <svg width="23" height="15" viewBox="0 0 23 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M5.25 14C5.25 14.4142 5.58579 14.75 6 14.75C6.41421 14.75 6.75 14.4142 6.75 14H5.25ZM6.53033 0.46967C6.23744 0.176777 5.76256 0.176777 5.46967 0.46967L0.696699 5.24264C0.403806 5.53553 0.403806 6.01041 0.696699 6.3033C0.989593 6.59619 1.46447 6.59619 1.75736 6.3033L6 2.06066L10.2426 6.3033C10.5355 6.59619 11.0104 6.59619 11.3033 6.3033C11.5962 6.01041 11.5962 5.53553 11.3033 5.24264L6.53033 0.46967ZM6.75 14L6.75 1H5.25L5.25 14H6.75Z"
                    fill="#1C2541" />
                <path
                    d="M17.75 1C17.75 0.585786 17.4142 0.25 17 0.25C16.5858 0.25 16.25 0.585786 16.25 1L17.75 1ZM16.4697 14.5303C16.7626 14.8232 17.2374 14.8232 17.5303 14.5303L22.3033 9.75736C22.5962 9.46447 22.5962 8.98959 22.3033 8.6967C22.0104 8.40381 21.5355 8.40381 21.2426 8.6967L17 12.9393L12.7574 8.6967C12.4645 8.40381 11.9896 8.40381 11.6967 8.6967C11.4038 8.98959 11.4038 9.46447 11.6967 9.75736L16.4697 14.5303ZM16.25 1L16.25 14H17.75L17.75 1L16.25 1Z"
                    fill="#1C2541" />
            </svg>
        </summary>
        <div class="burger_open_sort">
            <div class="close_icon">
                <div class="burger_stick_close3"></div>
                <div class="burger_stick_close4"></div>
            </div>
            <h4 class="burger_sort_title">Сортировать</h4>
            <form id="order_by" action=" {% if request.GET.q %}{% url "catalog:search" %}{% else %}{% url "catalog:index" %}{% endif %}" method='get'>         
                <ul class="summary_filters">

                    <li class="summary_filter">
                        <button name='order_by' id="Checkbox1" value="popularity_checkbox" class="filter_btn">

                            {% if request.GET.order_by == 'popularity_checkbox' %}
                                <input type="checkbox" class="custom_checkbox" checked>
                            {% else %}
                                <input type="checkbox" class="custom_checkbox">
                            {% endif %}

                            <label for="Checkbox1">По популярности</label>
                        </button>
                    </li>

                    <li class="summary_filter">
                        <button name='order_by' id="Checkbox2" value="price" class="filter_btn">

                            {% if request.GET.order_by == 'price' %}
                                <input type="checkbox" class="custom_checkbox" checked>
                            {% else %}
                                <input type="checkbox" class="custom_checkbox">
                            {% endif %}

                            <label for="Checkbox2">Сначала дешёвые</label>
                        </button>
                    </li>

                    <li class="summary_filter">
                        <button name='order_by' id="Checkbox3" value="-price"  class="filter_btn">

                            {% if request.GET.order_by == '-price' %} 
                                <input type="checkbox" class="custom_checkbox" checked>
                            {% else %}
                                <input type="checkbox" class="custom_checkbox">
                            {% endif %}

                            <label for="Checkbox3">Сначала дорогие</label>
                        </button>
                    </li>

                    <li class="summary_filter">
                        <button name='order_by' id="Checkbox4" value="-avg_rating" class="filter_btn">

                            {% if request.GET.order_by == '-avg_rating' %} 
                                <input type="checkbox" class="custom_checkbox" checked>
                            {% else %}
                                <input type="checkbox" class="custom_checkbox">
                            {% endif %}

                            <label for="Checkbox4">По рейтингу</label>
                        </button>
                    </li>
                </ul>
            </form>
        </div>
    </details>
{% endblock %}

{% block content %}
    <div class="main__container">
        <h2 class="products_title">Товары</h2>
        <div class="active_filters">
            <ul class="active_filters__list">
                <li class="active_filters__sub_list">
                    <form id="order_by" action=" {% if request.GET.q %}{% url "catalog:search" %}{% else %}{% url "catalog:index" %}{% endif %}" method='get'>
                        <details class="active_filters__details">
                            <summary class="active_filters__summary">

                                {% if request.GET.q %}
                                    <input type="hidden" name="q" id="{{ request.GET.q }}">
                                {% endif %}
                                
                                {% if request.GET.order_by %}
                                    {% if request.GET.order_by == 'popularity_checkbox' %}
                                        По популярности
                                    {% elif request.GET.order_by == 'price' %}
                                        Сначала дешёвые
                                    {% elif request.GET.order_by == '-price' %}
                                        Сначала дорогие
                                    {% elif request.GET.order_by == '-avg_rating' %}
                                        По рейтингу
                                    {% elif request.GET.order_by == 'default' %}
                                        По умолчанию
                                    {% endif %}
                                {% else %}
                                    Сортировать по
                                {% endif %}
                                
                                <div class="marker_container">
                                    <div class="summary_marker_stick1"></div>
                                    <div class="summary_marker_stick2"></div>
                                </div>
                            </summary>
                            <ul class="summary_filters">

                                <li class="summary_filter">
                                    <button name='order_by' id="Checkbox1" value="popularity_checkbox" class="filter_btn">

                                        {% if request.GET.order_by == 'popularity_checkbox' %}
                                            <input type="checkbox" class="custom_checkbox" checked>
                                        {% else %}
                                            <input type="checkbox" class="custom_checkbox">
                                        {% endif %}

                                        <label for="Checkbox1">По популярности</label>
                                    </button>
                                </li>

                                <li class="summary_filter">
                                    <button name='order_by' id="Checkbox2" value="price" class="filter_btn">

                                        {% if request.GET.order_by == 'price' %}
                                            <input type="checkbox" class="custom_checkbox" checked>
                                        {% else %}
                                            <input type="checkbox" class="custom_checkbox">
                                        {% endif %}

                                        <label for="Checkbox2">Сначала дешёвые</label>
                                    </button>
                                </li>

                                <li class="summary_filter">
                                    <button name='order_by' id="Checkbox3" value="-price"  class="filter_btn">

                                        {% if request.GET.order_by == '-price' %} 
                                            <input type="checkbox" class="custom_checkbox" checked>
                                        {% else %}
                                            <input type="checkbox" class="custom_checkbox">
                                        {% endif %}

                                        <label for="Checkbox3">Сначала дорогие</label>
                                    </button>
                                </li>

                                <li class="summary_filter">
                                    <button name='order_by' id="Checkbox4" value="-avg_rating" class="filter_btn">

                                        {% if request.GET.order_by == '-avg_rating' %} 
                                            <input type="checkbox" class="custom_checkbox" checked>
                                        {% else %}
                                            <input type="checkbox" class="custom_checkbox">
                                        {% endif %}

                                        <label for="Checkbox4">По рейтингу</label>
                                    </button>
                                </li>
                            </ul>
                        </details>
                    </form>
                </li>
                <li class="active_filter"></li>

                {% if request.GET.subscription %}
                    {% with subscription_id=request.GET.subscription|add:"0" %}
                        {% for subscription in subscriptions %}
                            {% if subscription_id == subscription.id %}
                                <li class="active_filter">{{ subscription.name }}</span></li>
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                {% endif %}
                
                {% if request.GET.category %}
                    {% with category_id=request.GET.category|add:"0" %}
                        {% for category in categories %}
                            {% if category_id == category.id %}
                                <li class="active_filter">{{ category.name }}</span></li>
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                {% endif %}
                
                <form  id="order_by" action=" {% if request.GET.q %}{% url "catalog:search" %}{% else %}{% url "catalog:index" %}{% endif %}" method='get'>
                    <li class="active_filter"><button type="submit" name='order_by' value="default" class="drop_filters">Сбросить все фильтры</button></li>
                </form>
                
            </ul>
        </div>
        <div class="filters_producs_container">
            <div class="filters_box">
                <h3 class="filters_producs__title">Фильтры</h3>

                <form id="price_form" action="{% url 'catalog:index' %}" method='get'>
                    <div class="price_spread_box">
                        <p class="price_spread_box__name">Цена, &#8381;</p>
                        <div class="price-range">
                            <div class="price_rage__input_label">
                                <label for="price_from">От</label>
                                <input type="text" name='sort_price_from' id="price_from" placeholder="{{ min_price }}" class="filter_price">
                            </div>
                            <div class="price_rage__input_label">
                                <label for="price_to">До</label>
                                <input type="text" name='sort_price_to' id="price_to" placeholder="{{ max_price }}" class="filter_price">
                            </div>
                        </div>
                    </div>
                </form>

                <form id="subscription_filter" action="{% if request.GET.q %}{% url 'catalog:search' %}{% else %}{% url 'catalog:index' %}{% endif %}" method="get">
                    <div class="validity_box">
                        <h4 class="validity_title">Срок действия</h4>
                        <ul class="validity_list">

                            {% for subscription in subscriptions %}
                                <li class="validity_list__item">
                                    <button id="{{ subscription.slug }}" name="subscription" value="{{ subscription.id }}" class="filter_btn">

                                        {% if request.GET.subscription == subscription.id|stringformat:"s" %}
                                            <input type="checkbox" class="custom_checkbox" checked>
                                        {% else %}
                                            <input type="checkbox" class="custom_checkbox">
                                        {% endif %}

                                        <label for="{{ subscription.slug }}" class="filter_label">{{ subscription.name }}</label>
                                    </button>
                                </li>
                            {% endfor %}

                        </ul>
                    </div>
                </form>


                <form id="in_stock_filter" action="{% url "catalog:index" %}" method='get'>
                    <div class="in_stock_box">
                        {% if not request.GET.in_stock  %}
                            <button id="id_in_stock" name="in_stock" value="Да" class="filter_btn">
                                {% if request.GET.in_stock == "Да" %}
                                    <input type="checkbox" class="custom_checkbox" checked>
                                {% else %}
                                    <input type="checkbox" class="custom_checkbox">
                                {% endif %}

                                <label for="stock_checkbox" class="stock_label">В наличии</label>
                            </button>
                        {% else %}
                            <button id="id_in_stock" name="in_stock" value="default" class="filter_btn">
                                {% if request.GET.in_stock == "Да" %}
                                    <input type="checkbox" class="custom_checkbox" checked>
                                {% else %}
                                    <input type="checkbox" class="custom_checkbox">
                                {% endif %}
                                <label for="stock_checkbox" class="stock_label">В наличии</label>
                            </button>
                        {% endif %}
                    </div>
                </form>

                <form id="category_filter" action="{% url "catalog:index" %}" method='get'>
                    <div class="operating_system_box">
                        <h4 class="operating_system_title">Операционная система</h4>
                        <ul class="operating_system_list">

                            {% for category in categories %}
                                {% if category.name != 'Все' %}
                                    <li class="operating_system">
                                        <button id="{{ category.slug }}" name="category" value="{{ category.id }}" class="filter_btn">

                                            {% if request.GET.category == category.id|stringformat:"s" %}
                                                <input type="checkbox" class="custom_checkbox" checked>
                                            {% else %}
                                                <input type="checkbox" class="custom_checkbox">
                                            {% endif %}

                                            <label for="{{ category.slug }}">{{ category.name }}</label>
                                        </button>
                                    </li>
                                {% endif %}
                            {% endfor %}

                        </ul>
                    </div>
                </form>

            </div>
            <div class="product_box">
                <ul class="products_list">
    
                    {% for product in products %}
                        <li class="product_card">
                            <a href="{% url "catalog:product" product.slug %}">
    
                                {% if product.image %}
                                    <div class="img_decor_card">
                                        <img src="{{ product.image.url }}" alt="" class="product__img shadow_element">
                                        <div class="decor_mini_card_img"></div>
                                    </div>
                                {% else %}
                                    <img src="{% static 'deps/отсутсвует.png' %}" alt="" class="product__img shadow_element">
                                {% endif %}
                            
                                {% if product.discount_percentage %}
                                    <p class="popular_sale">ВЫГОДНО</p>
                                {% else %}
                                    <p class="popular_sale"></p>
                                {% endif %}
    
                                <p class="product__name shadow_element">{{ product.name|truncatechars:30 }}</p>
    
                                {% if product.discount_percentage %}
                                    <p class="product__price shadow_element">{{ product.discount_price }} ₽</p>
                                {% else %}
                                    <p class="product__price shadow_element">{{ product.price }} ₽</p>
                                {% endif %}
    
                            </a>
                        </li>
                    {% endfor %}
    
                </ul>
                <ul class="page_num_list">
    
                    {% if products.paginator.page_range|length > 1 %}
                        {% for page in products.paginator.page_range %}
                            {% if page >= products.number|add:-1 and page <= products.number|add:1 %}
                                <a href="?{% change_params page=page %}"><li class="page_num">{{ page }}</li></a>
                            {% endif %}
                        {% endfor %}    
                    {% endif %}

                </ul>
            </div>
        </div>
    </div>

    <script>
        const priceForm = document.getElementById("price_form");
        const priceFromInput = document.getElementById("price_from");
        const priceToInput = document.getElementById("price_to");
    
        let typingTimer; // Таймер для отслеживания времени после окончания ввода
        const doneTypingInterval = 1200; // 1,2 секунды после окончания ввода
    
        // Функция для отправки формы после окончания ввода
        function submitFormAfterTyping() {
            clearTimeout(typingTimer); // Сбрасываем предыдущий таймер
    
            // Устанавливаем новый таймер
            typingTimer = setTimeout(function() {
                priceForm.submit(); // Отправляем форму
            }, doneTypingInterval);
        }
    
        // Добавляем обработчики событий для изменения значений в полях ввода
        priceFromInput.addEventListener("input", submitFormAfterTyping);
        priceToInput.addEventListener("input", submitFormAfterTyping);
    </script>
{% endblock  %}